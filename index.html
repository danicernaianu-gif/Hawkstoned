<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pattern Scout + Trade Planner</title>
<style>
  :root{
    --bg:#0f1116; --card:#141821; --muted:#23293a; --text:#e8ecf1; --text-dim:#9aa4b2;
    --accent:#7aa2ff; --accent-2:#63d297; --warn:#ffb86b; --bad:#ff6b6b; --good:#4cd984;
    --pill:#1e2331; --outline:#2a3246; --grid:#1b2231; --dash:#3b445a;
  }
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial,sans-serif}
  .wrap{max-width:1200px;margin:0 auto;padding:16px;display:grid;gap:16px;grid-template-columns:1fr;align-items:start}
  @media(min-width:980px){.wrap{grid-template-columns:1.1fr 0.9fr}}
  .card{background:var(--card);border:1px solid var(--outline);border-radius:12px;padding:12px;box-shadow:0 1px 0 rgba(0,0,0,.2)}
  .card h2{margin:0 0 8px 0;font-size:16px;font-weight:600}
  .controls{display:grid;gap:8px;grid-template-columns:1fr}
  @media(min-width:720px){.controls{grid-template-columns:repeat(3,1fr)}}
  button,.toggle,.filebtn,select{
    background:var(--muted);color:var(--text);border:1px solid var(--outline);border-radius:8px;padding:8px 10px;cursor:pointer
  }
  select{appearance:none}
  button:hover,.toggle:hover,.filebtn:hover,select:hover{border-color:var(--accent)}
  .toggle{display:inline-flex;gap:8px;align-items:center}
  .toggle input{accent-color:var(--accent)}
  textarea{width:100%;min-height:90px;resize:vertical;background:#0e121a;color:var(--text);border:1px dashed var(--outline);border-radius:8px;padding:8px}
  .drop{border:2px dashed var(--dash);border-radius:10px;padding:12px;text-align:center;color:var(--text-dim);background:#0d1118}
  .drop.drag{border-color:var(--accent);color:var(--accent)}
  .flex{display:flex;gap:12px;align-items:stretch}
  .flex-col{display:flex;flex-direction:column;gap:8px}
  .pills{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
  .pill{background:var(--pill);color:var(--text);border:1px solid var(--outline);border-radius:999px;padding:4px 8px;font-size:12px;cursor:pointer}
  .svgwrap{width:100%;height:380px;border:1px solid var(--outline);border-radius:10px;background:#0b0f16}
  svg{width:100%;height:100%;display:block}
  .grid5{display:grid;gap:10px;grid-template-columns:repeat(2,minmax(0,1fr))}
  @media(min-width:720px){.grid5{grid-template-columns:repeat(3,minmax(0,1fr))}}
  @media(min-width:1020px){.grid5{grid-template-columns:repeat(2,minmax(0,1fr))}}
  .tile{border:1px solid var(--outline);border-radius:10px;padding:10px;background:#0f1420;display:grid;grid-template-columns:auto 1fr;gap:10px;align-items:center;cursor:pointer}
  .badge{padding:2px 6px;border-radius:6px;font-size:11px;justify-self:end;border:1px solid var(--outline);background:#101520;color:var(--text-dim)}
  .badge.good{color:var(--good);border-color:var(--good)}
  .badge.bad{color:var(--bad);border-color:var(--bad)}
  .badge.warn{color:var(--warn);border-color:var(--warn)}
  .panel{border:1px solid var(--outline);border-radius:10px;padding:10px;background:#0f1420;margin-top:10px}
  label{color:var(--text-dim);font-size:12px;display:block;margin-bottom:3px}
  input[type="number"],input[type="text"]{width:100%;background:#0e121a;border:1px solid var(--outline);border-radius:8px;color:var(--text);padding:8px}
  .table{width:100%;border-collapse:collapse;margin-top:6px;font-size:13px}
  .table th,.table td{border:1px solid var(--outline);padding:6px 8px;text-align:right}
  .table th{background:#0f1622;color:var(--text-dim);font-weight:600}
  .table td:first-child,.table th:first-child{text-align:left}
  .hstack{display:flex;gap:8px}
  .note{color:var(--text-dim);font-size:12px}
</style>
</head>
<body>
<main class="wrap" role="main">
  <!-- Card 1 -->
  <section class="card" aria-labelledby="card1-title">
    <h2 id="card1-title">Data &amp; Controls</h2>
    <div class="controls" role="group" aria-label="Controls">
      <button id="btnSample" aria-label="Load Sample Data">Load Sample</button>
      <button id="btnDetect" aria-label="Run Pattern Detection">Run Detection</button>
      <label class="toggle" for="togLine"><input id="togLine" type="checkbox" /> Line only</label>
      <label class="toggle" for="togLoose"><input id="togLoose" type="checkbox" checked /> Sensitivity: <strong>&nbsp;<span id="sensLabel">Loose</span></strong></label>
      <label class="toggle" for="togZoom"><input id="togZoom" type="checkbox" checked /> Zoom-to-pattern</label>
    </div>

    <div class="flex" style="margin-top:10px;">
      <div class="flex-col" style="flex:1;">
        <label for="csvInput">Paste CSV (date|time, open, high, low, close, volume)</label>
        <textarea id="csvInput" aria-label="CSV input" placeholder="date,time,open,high,low,close,volume&#10;2025-01-01,09:30,100,102,99,101,15000"></textarea>
      </div>
      <div class="flex-col" style="width:280px;">
        <label for="dropzone">Upload</label>
        <div id="dropzone" class="drop" role="button" tabindex="0" aria-label="Drag and drop or choose a CSV file">
          Drag &amp; Drop CSV here<br/>or<br/>
          <button id="fileProxy" class="filebtn" aria-label="Choose a CSV file">Choose File</button>
          <input id="fileInput" type="file" accept=".csv,text/csv" hidden aria-hidden="true" />
        </div>
      </div>
    </div>

    <div aria-live="polite" id="detectOut" class="pills" style="min-height:28px;" aria-label="Detected patterns"></div>
    <div class="svgwrap" aria-label="Chart"><svg id="chart" role="img" aria-labelledby="chartTitle"><title id="chartTitle">Price &amp; Volume Chart</title></svg></div>
  </section>

  <!-- Card 2 -->
  <section class="card" aria-labelledby="card2-title">
    <h2 id="card2-title">Pattern Library &amp; Planner</h2>
    <div id="patternGrid" class="grid5" role="list" aria-label="Pattern types">
      <div class="tile" data-kind="DTDB" role="listitem" tabindex="0" aria-label="Double Top or Double Bottom">
        <svg width="56" height="36" aria-hidden="true"><polyline points="2,28 10,10 18,28 26,10 34,28 54,6" fill="none" stroke="currentColor" stroke-width="1.5"/><line x1="2" y1="30" x2="54" y2="30" stroke="currentColor" stroke-dasharray="3,3" opacity=".6"/></svg>
        <div><div class="hstack" style="justify-content:space-between;"><strong>Double Top/Bottom</strong><span class="badge" id="badge-DTDB">Not detected</span></div><div class="note">Peaks/troughs with neckline.</div></div>
      </div>
      <div class="tile" data-kind="FLAG" role="listitem" tabindex="0" aria-label="Flag or Pennant">
        <svg width="56" height="36" aria-hidden="true"><polyline points="2,30 14,12 26,6 38,8 50,10" fill="none" stroke="currentColor" stroke-width="1.5"/><polyline points="30,18 38,14 46,18 54,14" fill="none" stroke="currentColor" stroke-width="1" opacity=".8"/></svg>
        <div><div class="hstack" style="justify-content:space-between;"><strong>Flag/Pennant</strong><span class="badge" id="badge-FLAG">Not detected</span></div><div class="note">Impulse then consolidation.</div></div>
      </div>
      <div class="tile" data-kind="SRT" role="listitem" tabindex="0" aria-label="Support or Resistance Touch">
        <svg width="56" height="36" aria-hidden="true"><polyline points="2,24 12,20 22,26 32,20 42,26 54,20" fill="none" stroke="currentColor" stroke-width="1.5"/><line x1="2" y1="20" x2="54" y2="20" stroke="currentColor" stroke-dasharray="3,3" opacity=".6"/></svg>
        <div><div class="hstack" style="justify-content:space-between;"><strong>Support/Resistance Touch</strong><span class="badge" id="badge-SRT">Not detected</span></div><div class="note">Clustered touches at a level.</div></div>
      </div>
      <div class="tile" data-kind="HS" role="listitem" tabindex="0" aria-label="Head and Shoulders">
        <svg width="56" height="36" aria-hidden="true"><polyline points="2,28 12,14 20,28 28,6 36,28 44,14 54,28" fill="none" stroke="currentColor" stroke-width="1.5"/><line x1="4" y1="28" x2="52" y2="28" stroke="currentColor" stroke-dasharray="3,3" opacity=".6"/></svg>
        <div><div class="hstack" style="justify-content:space-between;"><strong>Head &amp; Shoulders</strong><span class="badge" id="badge-HS">Not detected</span></div><div class="note">L-H-R with neckline.</div></div>
      </div>
      <div class="tile" data-kind="CH" role="listitem" tabindex="0" aria-label="Cup and Handle">
        <svg width="56" height="36" aria-hidden="true"><path d="M2,16 C18,34 38,34 54,16" fill="none" stroke="currentColor" stroke-width="1.5"/><polyline points="38,16 46,20 54,18" fill="none" stroke="currentColor" stroke-width="1"/></svg>
        <div><div class="hstack" style="justify-content:space-between;"><strong>Cup &amp; Handle</strong><span class="badge" id="badge-CH">Not detected</span></div><div class="note">Rounded base + handle.</div></div>
      </div>
    </div>

    <!-- Trade Idea -->
    <div class="panel" aria-labelledby="trade-title">
      <h3 id="trade-title" style="margin:0 0 6px 0;font-size:15px;">Trade Idea</h3>
      <div class="hstack" style="flex-wrap:wrap;">
        <div style="min-width:90px;"><label for="tiSide">Side</label><select id="tiSide" aria-label="Trade side"><option value="long">Long</option><option value="short">Short</option></select></div>
        <div><label for="tiEntry">Entry</label><input id="tiEntry" type="number" step="0.0001" /></div>
        <div><label for="tiStop">Stop</label><input id="tiStop" type="number" step="0.0001" /></div>
        <div><label for="tiT1">Target 1 (1R)</label><input id="tiT1" type="number" step="0.0001" /></div>
        <div><label for="tiT2">Target 2 (1.5R)</label><input id="tiT2" type="number" step="0.0001" /></div>
        <div><label for="tiT3">Target 3 (2R)</label><input id="tiT3" type="number" step="0.0001" /></div>
      </div>
    </div>

    <!-- Risk & Position Size -->
    <div class="panel" aria-labelledby="risk-title">
      <h3 id="risk-title" style="margin:0 0 6px 0;font-size:15px;">Risk &amp; Position Size Planner</h3>
      <div class="hstack" style="flex-wrap:wrap;">
        <div><label for="accSize">Account Size</label><input id="accSize" type="number" step="0.01" value="10000" /></div>
        <div><label for="riskPct">Risk %</label><input id="riskPct" type="number" step="0.1" value="1" /></div>
        <div><label for="feesPs">Fees/Slippage (per share)</label><input id="feesPs" type="number" step="0.0001" value="0.01" /></div>
      </div>
      <table class="table" aria-label="Position sizing and PnL">
        <thead><tr><th>Metric</th><th>Value</th></tr></thead>
        <tbody id="riskTable"></tbody>
      </table>
    </div>

    <!-- Volume & News -->
    <div class="panel" aria-labelledby="vn-title">
      <h3 id="vn-title" style="margin:0 0 6px 0;font-size:15px;">Volume Validator &amp; News Scanner</h3>
      <div class="hstack" style="flex-wrap:wrap;">
        <div><label for="volThresh">Volume Threshold (×20SMA)</label><input id="volThresh" type="number" step="0.1" value="1.2" /></div>
        <div style="align-self:end;"><button id="btnValidateVol">Validate Volume</button></div>
        <div id="volOut" class="note" aria-live="polite"></div>
      </div>
      <div class="hstack" style="margin-top:8px;flex-wrap:wrap;">
        <div style="flex:1;min-width:280px;"><label for="newsPaste">Paste recent headlines (one per line)</label><textarea id="newsPaste" placeholder="AAPL beats earnings expectations...&#10;Company raises guidance...&#10;Lawsuit filed in federal court..."></textarea></div>
        <div style="width:160px;align-self:end;"><button id="btnScanNews">Scan News</button><div id="newsOut" class="note" aria-live="polite" style="margin-top:6px;"></div></div>
      </div>
    </div>
  </section>
</main>

<script>
(function(){
  'use strict';
  const state = { raw:[], view:{i0:0,i1:0}, detections:[], focused:null, settings:{ lineOnly:false, loose:true, zoom:true } };
  const els = {
    chart: document.getElementById('chart'),
    csvInput: document.getElementById('csvInput'),
    dropzone: document.getElementById('dropzone'),
    fileInput: document.getElementById('fileInput'),
    fileProxy: document.getElementById('fileProxy'),
    btnSample: document.getElementById('btnSample'),
    btnDetect: document.getElementById('btnDetect'),
    detectOut: document.getElementById('detectOut'),
    togLine: document.getElementById('togLine'),
    togLoose: document.getElementById('togLoose'),
    togZoom: document.getElementById('togZoom'),
    sensLabel: document.getElementById('sensLabel'),
    badge:{ DTDB:document.getElementById('badge-DTDB'), FLAG:document.getElementById('badge-FLAG'), SRT:document.getElementById('badge-SRT'), HS:document.getElementById('badge-HS'), CH:document.getElementById('badge-CH')},
    patternGrid: document.getElementById('patternGrid'),
    tiSide:document.getElementById('tiSide'), tiEntry:document.getElementById('tiEntry'), tiStop:document.getElementById('tiStop'),
    tiT1:document.getElementById('tiT1'), tiT2:document.getElementById('tiT2'), tiT3:document.getElementById('tiT3'),
    accSize:document.getElementById('accSize'), riskPct:document.getElementById('riskPct'), feesPs:document.getElementById('feesPs'), riskTable:document.getElementById('riskTable'),
    volThresh:document.getElementById('volThresh'), btnValidateVol:document.getElementById('btnValidateVol'), volOut:document.getElementById('volOut'),
    newsPaste:document.getElementById('newsPaste'), btnScanNews:document.getElementById('btnScanNews'), newsOut:document.getElementById('newsOut')
  };

  // Utils
  const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
  function SMA(arr,n){ const out=Array(arr.length).fill(NaN); let s=0; for(let i=0;i<arr.length;i++){ s+=arr[i]; if(i>=n)s-=arr[i-n]; if(i>=n-1) out[i]=s/n; } return out; }
  function linearRegression(y){ const n=y.length; let sx=0,sy=0,sxy=0,sxx=0; for(let i=0;i<n;i++){ sx+=i; sy+=y[i]; sxy+=i*y[i]; sxx+=i*i; } const b=(n*sxy - sx*sy)/(n*sxx - sx*sx + 1e-9); const a=(sy - b*sx)/n; return {a,b}; }
  function rel(a,b){ return Math.abs(a-b)/((a+b)/2); }
  function findMinIndex(arr,L,R,key){ let mi=L; for(let i=L;i<=R;i++){ if(arr[i][key]<arr[mi][key]) mi=i; } return mi; }
  function findMaxIndex(arr,L,R,key){ let mi=L; for(let i=L;i<=R;i++){ if(arr[i][key]>arr[mi][key]) mi=i; } return mi; }
  function uniqMaxMin(arr,i,win,isMax){
    const L=Math.max(0,i-win), R=Math.min(arr.length-1,i+win), slice=arr.slice(L,R+1);
    const extreme=isMax? Math.max(...slice):Math.min(...slice);
    if(arr[i]!==extreme) return false;
    let cnt=0; for(const v of slice){ if(v===extreme) cnt++; }
    return cnt===1;
  }
  function pivots(data, win){
    const c=data.map(d=>d.c), ph=[], pl=[];
    for(let i=0;i<c.length;i++){ if(uniqMaxMin(c,i,win,true)) ph.push({i,p:c[i]}); if(uniqMaxMin(c,i,win,false)) pl.push({i,p:c[i]}); }
    return {ph,pl};
  }

  // CSV parsing (robust headers)
  function parseCSV(text){
    const lines=text.split(/\r?\n/).filter(x=>x.trim().length>0);
    if(lines.length<2) return [];
    const head=lines[0].split(',').map(h=>h.trim().toLowerCase());
    const idxOf=(name)=> head.indexOf(name);
    const iDate = idxOf('date'), iTime = idxOf('time'), iDT = (idxOf('datetime')>-1? idxOf('datetime') : idxOf('timestamp'));
    const iOpen=idxOf('open'), iHigh=idxOf('high'), iLow=idxOf('low'), iClose=idxOf('close'), iVol=idxOf('volume');
    const haveTimeCol = iDate>-1 && iTime>-1;
    const haveSingleTS = iDT>-1 || iDate>-1;
    if([iOpen,iHigh,iLow,iClose,iVol].some(i=>i<0) || (!haveTimeCol && !haveSingleTS)) return [];

    const out=[];
    for(let li=1; li<lines.length; li++){
      const parts=lines[li].split(',');
      const get=(i)=> (i>=0 && i<parts.length)? parts[i].trim() : '';
      let t;
      if(haveTimeCol){
        const ds=get(iDate), ts=get(iTime);
        const combo = (ds && ts)? `${ds} ${ts}` : (ds||ts);
        t = Date.parse(combo);
      }else if(iDT>-1){
        const raw=get(iDT);
        t = /^\d{10,13}$/.test(raw)? (+raw.length===13? +raw : +raw*1000) : Date.parse(raw);
      }else{
        const raw=get(iDate);
        t = /^\d{10,13}$/.test(raw)? (+raw.length===13? +raw : +raw*1000) : Date.parse(raw);
      }
      if(!isFinite(t)) continue;

      const o=+get(iOpen), h=+get(iHigh), l=+get(iLow), c=+get(iClose), v=+get(iVol);
      if([o,h,l,c,v].some(x=>!isFinite(x))) continue;
      out.push({ t: t, o,h,l,c,v });
    }
    out.sort((a,b)=>a.t-b.t);
    return out;
  }

  // Sample data (tends to yield S/R or Flag)
  function synthSample(n=200){
    const out=[]; let price=100, vol=15000;
    const rnd=()=> (Math.random()-0.5);
    for(let i=0;i<n;i++){
      const trend=(i<60)?0.05:(i<110?0.25:-0.02);
      const noise=rnd()*0.6;
      const ret=(trend+noise)/100;
      const prev=price; price=Math.max(20, price*(1+ret));
      const high=Math.max(prev,price)*(1+Math.random()*0.004);
      const low=Math.min(prev,price)*(1-Math.random()*0.004);
      const open=prev*(1 + rnd()*0.002);
      const close=price;
      vol=Math.max(6000, vol*(1 + rnd()*0.15 + (i%45===0?0.8:0)));
      out.push({ t: 1700000000000 + i*3600e3, o:open, h:high, l:low, c:close, v:Math.round(vol) });
    }
    for(let i=120;i<140 && i<out.length;i++){
      const base=out[120].c, ch=(i-120), wiggle=Math.sin(ch/3)*0.004;
      out[i].c=base*(1 + 0.02 + wiggle + (ch*-0.0005));
      out[i].h=Math.max(out[i].h, out[i].c*(1+0.003));
      out[i].l=Math.min(out[i].l, out[i].c*(1-0.003));
      out[i].v=Math.round(out[i].v*0.8);
    }
    return out;
  }

  // Chart
  function clearSVG(){ while(els.chart.firstChild) els.chart.removeChild(els.chart.firstChild); }
  function setFullView(){ state.view.i0=0; state.view.i1=Math.max(1,state.raw.length-1); }
  function drawChart(){
    clearSVG(); const data=state.raw; if(data.length===0) return;
    const w=els.chart.clientWidth||els.chart.parentElement.clientWidth||600, h=els.chart.clientHeight||380;
    const padL=46,padR=16,padT=14,padB=52, innerW=Math.max(10,w-padL-padR), innerH=Math.max(10,h-padT-padB);
    let i0=clamp(state.view.i0,0,data.length-1), i1=clamp(state.view.i1,i0+1,data.length-1);
    const slice=data.slice(i0,i1+1);
    const maxH=Math.max(...slice.map(d=>d.h)), minL=Math.min(...slice.map(d=>d.l)), maxV=Math.max(1,...slice.map(d=>d.v));
    const x=(i)=> padL + ((i-i0)/(i1-i0))*innerW;
    const y=(p)=> padT + (1 - (p-minL)/(maxH-minL+1e-9))*innerH;
    const yV=(v)=> padT + innerH + 2 - (v/maxV)*(padB-14);

    const bg=document.createElementNS('http://www.w3.org/2000/svg','rect');
    bg.setAttribute('x',0);bg.setAttribute('y',0);bg.setAttribute('width',w);bg.setAttribute('height',h);bg.setAttribute('fill','#0b0f16');
    els.chart.appendChild(bg);

    const grid=document.createElementNS('http://www.w3.org/2000/svg','g');
    for(let i=0;i<=6;i++){ const lx=padL+i*innerW/6, ln=document.createElementNS('http://www.w3.org/2000/svg','line'); ln.setAttribute('x1',lx);ln.setAttribute('y1',padT);ln.setAttribute('x2',lx);ln.setAttribute('y2',padT+innerH);ln.setAttribute('stroke','#1b2231');ln.setAttribute('stroke-width','1'); grid.appendChild(ln); }
    for(let j=0;j<=4;j++){ const ly=padT+j*innerH/4, ln=document.createElementNS('http://www.w3.org/2000/svg','line'); ln.setAttribute('x1',padL);ln.setAttribute('y1',ly);ln.setAttribute('x2',padL+innerW);ln.setAttribute('y2',ly);ln.setAttribute('stroke','#1b2231');ln.setAttribute('stroke-width','1'); grid.appendChild(ln); }
    els.chart.appendChild(grid);

    if(state.focused!=null){ const p=state.detections[state.focused];
      if(p){ const hx=x(p.idx[0]), hx2=x(p.idx[1]); const rect=document.createElementNS('http://www.w3.org/2000/svg','rect');
        rect.setAttribute('x',Math.min(hx,hx2)); rect.setAttribute('y',padT); rect.setAttribute('width',Math.abs(hx2-hx)); rect.setAttribute('height',innerH);
        rect.setAttribute('fill','#7aa2ff22'); rect.setAttribute('stroke','#7aa2ff55'); rect.setAttribute('stroke-width','1'); els.chart.appendChild(rect);
        if(p.extra?.neck){ const ly=y(p.extra.neck), ln=document.createElementNS('http://www.w3.org/2000/svg','line'); ln.setAttribute('x1',padL);ln.setAttribute('x2',padL+innerW);ln.setAttribute('y1',ly);ln.setAttribute('y2',ly);ln.setAttribute('stroke','#63d297');ln.setAttribute('stroke-dasharray','5,4');ln.setAttribute('opacity','0.9'); els.chart.appendChild(ln); }
        if(p.level){ const ly=y(p.level), ln=document.createElementNS('http://www.w3.org/2000/svg','line'); ln.setAttribute('x1',padL);ln.setAttribute('x2',padL+innerW);ln.setAttribute('y1',ly);ln.setAttribute('y2',ly);ln.setAttribute('stroke','#ffb86b');ln.setAttribute('stroke-dasharray','5,4');ln.setAttribute('opacity','0.9'); els.chart.appendChild(ln); }
      }
    }

    if(state.settings.lineOnly){
      const path=document.createElementNS('http://www.w3.org/2000/svg','path'); let d='';
      for(let i=i0;i<=i1;i++){ const cx=x(i), cy=y(data[i].c); d+= (i===i0?`M${cx},${cy}`:`L${cx},${cy}`); }
      path.setAttribute('d',d); path.setAttribute('fill','none'); path.setAttribute('stroke','#e8ecf1'); path.setAttribute('stroke-width','1.5'); els.chart.appendChild(path);
    }else{
      const cw=Math.max(1, innerW/(i1-i0+1)*0.6);
      for(let i=i0;i<=i1;i++){ const d=data[i];
        const wl=document.createElementNS('http://www.w3.org/2000/svg','line'); wl.setAttribute('x1',x(i)); wl.setAttribute('x2',x(i)); wl.setAttribute('y1',y(d.h)); wl.setAttribute('y2',y(d.l)); wl.setAttribute('stroke','#9aa4b2'); wl.setAttribute('stroke-width','1'); els.chart.appendChild(wl);
        const up=d.c>=d.o; const r=document.createElementNS('http://www.w3.org/2000/svg','rect'); r.setAttribute('x',x(i)-cw/2); r.setAttribute('width',cw); r.setAttribute('y',y(Math.max(d.o,d.c))); r.setAttribute('height',Math.max(1,Math.abs(y(d.o)-y(d.c)))); r.setAttribute('fill', up? '#63d297':'#ff6b6b'); els.chart.appendChild(r);
      }
    }
    const vw=Math.max(1,innerW/(i1-i0+1)*0.7);
    for(let i=i0;i<=i1;i++){ const d=data[i]; const vr=document.createElementNS('http://www.w3.org/2000/svg','rect'); vr.setAttribute('x',x(i)-vw/2); vr.setAttribute('width',vw); vr.setAttribute('y',yV(d.v)); vr.setAttribute('height',padT+innerH - yV(d.v)); vr.setAttribute('fill','#2a3246'); els.chart.appendChild(vr); }

    function addLabel(yv,txt){ const t=document.createElementNS('http://www.w3.org/2000/svg','text'); t.setAttribute('x',52); t.setAttribute('y',yv); t.setAttribute('fill','#9aa4b2'); t.setAttribute('font-size','11'); t.textContent=txt; els.chart.appendChild(t); }
    addLabel(y(maxH), maxH.toFixed(2)); addLabel(y(minL), minL.toFixed(2));
  }

  // Detection helpers
  function bestRangeAround(idx){ const L=clamp(idx[0]-10,0,state.raw.length-2), R=clamp(idx[1]+10,L+1,state.raw.length-1); return [L,R]; }

  function detectDoubleTB(data, loose){
    const win=loose?2:3, tol=loose?0.05:0.03, minSep=loose?2:3; const {ph,pl}=pivots(data,win); const out=[];
    for(let a=0;a<ph.length;a++) for(let b=a+1;b<ph.length;b++){ if(ph[b].i-ph[a].i<minSep) continue; if(rel(ph[a].p,ph[b].p)<=tol){ const mi=findMinIndex(data,ph[a].i,ph[b].i,'l'), neck=data[mi].l, iStart=ph[a].i, iEnd=ph[b].i, span=iEnd-iStart, mismatch=rel(ph[a].p,ph[b].p); let conf=70+Math.min(15,span*1.2)-mismatch*100*0.6; conf=clamp(conf,45,95); out.push({type:'Double Top',idx:[iStart,iEnd],level:(ph[a].p+ph[b].p)/2,extra:{neck},confidence:Math.round(conf)}); } }
    for(let a=0;a<pl.length;a++) for(let b=a+1;b<pl.length;b++){ if(pl[b].i-pl[a].i<minSep) continue; if(rel(pl[a].p,pl[b].p)<=tol){ const mi=findMaxIndex(data,pl[a].i,pl[b].i,'h'), neck=data[mi].h, iStart=pl[a].i, iEnd=pl[b].i, span=iEnd-iStart, mismatch=rel(pl[a].p,pl[b].p); let conf=70+Math.min(15,span*1.2)-mismatch*100*0.6; conf=clamp(conf,45,95); out.push({type:'Double Bottom',idx:[iStart,iEnd],level:(pl[a].p+pl[b].p)/2,extra:{neck},confidence:Math.round(conf)}); } }
    return out;
  }

  function detectFlagPennant(data, loose){
    const impulseLen=loose?12:10, consLen=loose?9:7, minRet=loose?0.09:0.08, out=[]; if(data.length<impulseLen+consLen+5) return out;
    for(let s=0; s+impulseLen+consLen < data.length-5; s++){
      const i0=s, i1=s+impulseLen, p0=data[i0].c, p1=data[i1].c, ret=(p1-p0)/p0; if(Math.abs(ret)<minRet) continue;
      const dir=Math.sign(ret)||1, c0=i1, c1=c0+consLen, cons=data.slice(c0,c1+1).map(d=>d.c);
      const {a:au,b:bu}=linearRegression(cons.map((v,i)=> v + (i%2? +0.0001:-0.0001)));
      const {a:al,b:bl}=linearRegression(cons.map((v,i)=> v - (i%2? +0.0001:-0.0001)));
      const y0u=au+bu*0, y1u=au+bu*cons.length, y0l=al+bl*0, y1l=al+bl*cons.length;
      const slopeDiff=Math.abs(bu-bl), mid=cons[Math.floor(cons.length/2)], chRange=(Math.max(y0u,y1u)-Math.min(y0l,y1l))/Math.max(1e-9,mid);
      const isPennant=(slopeDiff<0.006)||(chRange<0.06), idx=[i0, Math.min(c1+5,data.length-1)], confidence=clamp(65+Math.min(20,Math.abs(ret)*600)+(isPennant?5:0),50,93);
      out.push({type:'Flag/Pennant', idx, level:null, extra:{direction:dir}, confidence:Math.round(confidence)});
    }
    return out;
  }

  function detectSupportResistanceTouch(data, loose){
    const win=loose?2:3, tol=loose?0.015:0.01; const {ph,pl}=pivots(data,win);
    function cluster(piv){
      if(piv.length<3) return null;
      for(let a=0;a<=piv.length-3;a++){
        for(let b=a+1;b<piv.length;b++){
          const lvl=(piv[a].p+piv[b].p)/2;
          const touches=piv.filter(x=> Math.abs(x.p-lvl)/lvl <= tol);
          if(touches.length>=3){
            const idx=[Math.min(...touches.map(t=>t.i)), Math.max(...touches.map(t=>t.i))];
            const kind=(piv===ph)?'Resistance Touches':'Support Touches';
            const confidence=clamp(60+Math.min(25,(touches.length-3)*8),55,92);
            return { type:kind, idx, level:lvl, extra:{touches:touches.length}, confidence:Math.round(confidence) };
          }
        }
      }
      return null;
    }
    // REQUIRED PATCH LINE:
    return cluster(ph) || cluster(pl);
  }

  function detectHeadShoulders(data, loose){
    const win=loose?2:3, shoulderTol=loose?0.12:0.08, headGap=loose?0.005:0.01, spanMin=loose?6:4;
    const {ph}=pivots(data,win), out=[];
    for(let i=0;i+2<ph.length;i++){
      const L=ph[i], H=ph[i+1], R=ph[i+2];
      if(!(R.i>H.i && H.i>L.i)) continue; if(R.i-L.i<spanMin) continue;
      if(rel(L.p,R.p)<=shoulderTol && (H.p >= Math.max(L.p,R.p)*(1+headGap))){
        const mi1=findMinIndex(data,L.i,H.i,'l'), mi2=findMinIndex(data,H.i,R.i,'l'), neck=(data[mi1].l+data[mi2].l)/2;
        const conf=clamp(68+Math.min(15,(R.i-L.i)*1.5) - rel(L.p,R.p)*50,50,94);
        out.push({type:'Head & Shoulders', idx:[L.i,R.i], level:null, extra:{neck}, confidence:Math.round(conf)});
      }
    }
    return out;
  }

  function detectCupHandle(data, loose){
    const n=loose?6:8; if(data.length<30) return [];
    const c=data.map(d=>d.c), s=SMA(c,n), out=[];
    for(let i=0;i<data.length-20;i++){
      const j=i+18, sub=s.slice(i,j+1); if(sub.some(v=>!isFinite(v))) continue;
      const maxRim=Math.max(sub[0], sub[sub.length-1]), minBase=Math.min(...sub), depth=(maxRim-minBase)/maxRim, rimSym=rel(sub[0],sub[sub.length-1]);
      const needDepth=loose?0.06:0.08, rimTol=loose?0.14:0.10;
      if(depth>=needDepth && rimSym<=rimTol){
        const h0=j+1, h1=Math.min(h0+8,data.length-1), handleArr=c.slice(h0,h1+1), handlePull=(Math.max(...handleArr)-Math.min(...handleArr))/maxRim;
        if(handlePull < depth*0.5){
          const conf=clamp(66+Math.min(14,depth*120)-rimSym*40,50,92);
          out.push({type:'Cup & Handle', idx:[i,h1], level:maxRim, extra:{handleLow:Math.min(...handleArr)}, confidence:Math.round(conf)});
        }
      }
    }
    return out;
  }

  function renderPills(det){
    els.detectOut.innerHTML='';
    det.forEach((p,i)=>{
      const pill=document.createElement('button'); pill.type='button'; pill.className='pill';
      pill.setAttribute('aria-label',`Focus ${p.type} confidence ${p.confidence} percent`);
      pill.textContent=`${p.type} • ${p.confidence}%`;
      pill.addEventListener('click',()=>focusPattern(i,true));
      els.detectOut.appendChild(pill);
    });
  }

  function setBadges(det){
    const kinds={DTDB:0,FLAG:0,SRT:0,HS:0,CH:0};
    det.forEach(p=>{
      if(p.type==='Double Top'||p.type==='Double Bottom') kinds.DTDB=Math.max(kinds.DTDB,p.confidence);
      if(p.type==='Flag/Pennant') kinds.FLAG=Math.max(kinds.FLAG,p.confidence);
      if(p.type==='Support Touches'||p.type==='Resistance Touches') kinds.SRT=Math.max(kinds.SRT,p.confidence);
      if(p.type==='Head & Shoulders') kinds.HS=Math.max(kinds.HS,p.confidence);
      if(p.type==='Cup & Handle') kinds.CH=Math.max(kinds.CH,p.confidence);
    });
    function setBadge(id,val){ const el=els.badge[id]; if(!val){ el.textContent='Not detected'; el.className='badge'; } else { el.textContent=`Detected ${val}%`; el.className='badge good'; } }
    setBadge('DTDB',kinds.DTDB); setBadge('FLAG',kinds.FLAG); setBadge('SRT',kinds.SRT); setBadge('HS',kinds.HS); setBadge('CH',kinds.CH);
    if(state.raw.length<40){ Object.keys(els.badge).forEach(k=>{ if(els.badge[k].textContent==='Not detected'){ els.badge[k].textContent='Needs more data'; els.badge[k].className='badge warn'; } }); }
  }

  function fillTradeIdeaFromPattern(p){
    const d=state.raw, start=p.idx[0], end=p.idx[1], endBar=d[end], last=d[Math.min(end+1,d.length-1)].c;
    let side='long', entry=last, stop=last*0.99, t1,t2,t3;
    const tf=(entry,stop,side)=>{ const r=Math.abs(entry-stop), dir=(side==='long')?1:-1; return [+(entry+dir*1*r).toFixed(4), +(entry+dir*1.5*r).toFixed(4), +(entry+dir*2*r).toFixed(4)]; };
    switch(p.type){
      case 'Double Top': side='short'; entry=p.extra.neck; stop=Math.max(d[start].h,d[end].h)*1.003; [t1,t2,t3]=tf(entry,stop,side); break;
      case 'Double Bottom': side='long'; entry=p.extra.neck; stop=Math.min(d[start].l,d[end].l)*0.997; [t1,t2,t3]=tf(entry,stop,side); break;
      case 'Flag/Pennant': side=(p.extra.direction>0)?'long':'short'; entry=last; stop=side==='long'? d[start].l*0.997 : d[start].h*1.003; [t1,t2,t3]=tf(entry,stop,side); break;
      case 'Support Touches': side='long'; entry=p.level; stop=p.level*0.98; [t1,t2,t3]=tf(entry,stop,side); break;
      case 'Resistance Touches': side='short'; entry=p.level; stop=p.level*1.02; [t1,t2,t3]=tf(entry,stop,side); break;
      case 'Head & Shoulders': side='short'; entry=p.extra.neck; stop=d[end].h*1.003; [t1,t2,t3]=tf(entry,stop,side); break;
      case 'Cup & Handle': side='long'; entry=Math.max(p.level,endBar.c); stop=p.extra.handleLow*0.997; [t1,t2,t3]=tf(entry,stop,side); break;
    }
    els.tiSide.value=side; els.tiEntry.value=(entry||last).toFixed(4); els.tiStop.value=(stop).toFixed(4);
    els.tiT1.value=t1||''; els.tiT2.value=t2||''; els.tiT3.value=t3||'';
    updateRiskTable();
  }

  function updateRiskTable(){
    const side=els.tiSide.value, entry=parseFloat(els.tiEntry.value), stop=parseFloat(els.tiStop.value),
          t1=parseFloat(els.tiT1.value), t2=parseFloat(els.tiT2.value), t3=parseFloat(els.tiT3.value),
          acc=+els.accSize.value, rpct=(+els.riskPct.value)/100, fee=+els.feesPs.value;
    const riskAmt=acc*rpct, riskPerShare=Math.max(0.0001,Math.abs(entry-stop))+fee, qty=Math.max(0,Math.floor(riskAmt/riskPerShare));
    function pnl(target){ if(!isFinite(target)) return {gross:0,net:0,rr:0}; const diff=(side==='long')? (target-entry):(entry-target); const gross=diff*qty, net=gross - fee*qty, rr=(Math.abs(diff)/Math.abs(entry-stop)); return {gross,net,rr}; }
    const P1=pnl(t1), P2=pnl(t2), P3=pnl(t3), f=(x)=>isFinite(x)? x.toFixed(2):'-';
    els.riskTable.innerHTML=`
      <tr><td>Risk Amount</td><td>$${f(riskAmt)}</td></tr>
      <tr><td>Risk/Share (incl. fees)</td><td>$${f(riskPerShare)}</td></tr>
      <tr><td>Position Size (shares)</td><td>${qty}</td></tr>
      <tr><td>Target 1 Gross / Net / R:R</td><td>$${f(P1.gross)} / $${f(P1.net)} / ${f(P1.rr)}</td></tr>
      <tr><td>Target 2 Gross / Net / R:R</td><td>$${f(P2.gross)} / $${f(P2.net)} / ${f(P2.rr)}</td></tr>
      <tr><td>Target 3 Gross / Net / R:R</td><td>$${f(P3.gross)} / $${f(P3.net)} / ${f(P3.rr)}</td></tr>`;
  }

  function validateVolume(){
    const d=state.raw; if(d.length<21){ els.volOut.textContent='Need ≥ 21 bars.'; els.volOut.style.color='var(--text-dim)'; return; }
    const last=d[d.length-1].v, v20=d.slice(-20).reduce((a,b)=>a+b.v,0)/20, thr=parseFloat(els.volThresh.value)||1.2;
    const pass= last >= v20*thr;
    els.volOut.textContent= pass? `PASS: Last vol ${Math.round(last)} ≥ ${thr.toFixed(2)}× 20SMA (${Math.round(v20)}).` : `FAIL: Last vol ${Math.round(last)} < ${thr.toFixed(2)}× 20SMA (${Math.round(v20)}).`;
    els.volOut.style.color= pass? 'var(--good)':'var(--bad)';
  }

  function scanNews(){
    const txt=els.newsPaste.value||''; if(!txt.trim()){ els.newsOut.textContent='No headlines pasted.'; els.newsOut.style.color='var(--text-dim)'; return; }
    const lines=txt.split(/\r?\n/).filter(x=>x.trim().length>0);
    const buckets={Earnings:/\b(earnings|eps|revenue|beat|miss)\b/i, Guidance:/\b(guidance|forecast|outlook|raises?|cuts?)\b/i, 'M&A':/\b(acquires?|merger|acquisition|takeover|bid)\b/i, Legal:/\b(lawsuit|probe|investigation|settlement|antitrust|sec|doj|fine|fraud)\b/i, Analyst:/\b(downgrade|upgrade|initiates?|price target|overweight|underweight)\b/i};
    const tags={Earnings:false,Guidance:false,'M&A':false,Legal:false,Analyst:false};
    for(const ln of lines){ for(const k in buckets){ if(buckets[k].test(ln)) tags[k]=true; } }
    const gateFail=tags.Legal===true, tagList=Object.keys(tags).filter(k=>tags[k]).join(', ')||'None';
    els.newsOut.textContent= gateFail? `GATE FAIL (Legal present). Tags: ${tagList}` : `OK. Tags: ${tagList}`;
    els.newsOut.style.color= gateFail? 'var(--bad)': 'var(--good)';
  }

  function renderPillsAndBadges(){ setBadges(state.detections); renderPills(state.detections); }

  function focusPattern(index, doZoom){
    state.focused=index; const p=state.detections[index]; if(!p) return;
    if(state.settings.zoom && doZoom){ const [L,R]=bestRangeAround(p.idx); state.view.i0=L; state.view.i1=R; } else { setFullView(); }
    fillTradeIdeaFromPattern(p); drawChart();
  }

  function runDetection(){
    if(state.raw.length<5){ alert('Need more data. Paste CSV or load sample.'); return; }
    const loose=state.settings.loose, data=state.raw; let det=[];
    det=det.concat(detectDoubleTB(data,loose));
    det=det.concat(detectFlagPennant(data,loose));
    const srt=detectSupportResistanceTouch(data,loose); if(srt) det.push(srt);
    det=det.concat(detectHeadShoulders(data,loose));
    det=det.concat(detectCupHandle(data,loose));
    det.sort((a,b)=> b.confidence-a.confidence);
    state.detections=det; renderPillsAndBadges();
    if(det.length>0){ focusPattern(0,true); } else { state.focused=null; setFullView(); drawChart(); }
  }

  function dataChanged(){
    state.detections=[]; state.focused=null; setBadges([]); renderPills([]); if(state.raw.length>0) setFullView(); drawChart();
  }

  // Wire
  els.csvInput.addEventListener('input', ()=>{ try{ state.raw=parseCSV(els.csvInput.value); dataChanged(); }catch(e){ console.error(e); } });

  ['dragenter','dragover'].forEach(ev=> els.dropzone.addEventListener(ev, (e)=>{ e.preventDefault(); e.stopPropagation(); els.dropzone.classList.add('drag'); }));
  ['dragleave','drop'].forEach(ev=> els.dropzone.addEventListener(ev, (e)=>{ e.preventDefault(); e.stopPropagation(); els.dropzone.classList.remove('drag'); }));
  els.dropzone.addEventListener('drop', (e)=>{ const f=e.dataTransfer.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=(ev)=>{ els.csvInput.value=ev.target.result; els.csvInput.dispatchEvent(new Event('input')); }; r.readAsText(f); });
  els.fileProxy.addEventListener('click', ()=> els.fileInput.click());
  els.dropzone.addEventListener('click', (e)=>{ if(e.target.id==='fileProxy') return; els.fileInput.click(); });
  els.fileInput.addEventListener('change', (e)=>{ const f=e.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=(ev)=>{ els.csvInput.value=ev.target.result; els.csvInput.dispatchEvent(new Event('input')); }; r.readAsText(f); });

  els.togLine.addEventListener('change', ()=>{ state.settings.lineOnly=!!els.togLine.checked; drawChart(); });
  els.togLoose.addEventListener('change', ()=>{ state.settings.loose=!!els.togLoose.checked; els.sensLabel.textContent=state.settings.loose?'Loose':'Strict'; });
  els.togZoom.addEventListener('change', ()=>{ state.settings.zoom=!!els.togZoom.checked; });

  els.btnSample.addEventListener('click', ()=>{
    state.raw=synthSample(200);
    const rows=['date,open,high,low,close,volume'].concat(state.raw.map(d=>[new Date(d.t).toISOString(), d.o.toFixed(4), d.h.toFixed(4), d.l.toFixed(4), d.c.toFixed(4), d.v].join(','))).join('\n');
    els.csvInput.value=rows; dataChanged();
  });

  els.btnDetect.addEventListener('click', runDetection);

  // Tile click -> focus highest confidence of that kind
  els.patternGrid.querySelectorAll('.tile').forEach(tile=>{
    tile.addEventListener('click', ()=>{
      const kind=tile.getAttribute('data-kind');
      let bestIndex=-1, bestConf=-1;
      state.detections.forEach((p,i)=>{
        const match = (kind==='DTDB' && (p.type==='Double Top'||p.type==='Double Bottom')) ||
                      (kind==='FLAG' && p.type==='Flag/Pennant') ||
                      (kind==='SRT' && (p.type==='Support Touches'||p.type==='Resistance Touches')) ||
                      (kind==='HS' && p.type==='Head & Shoulders') ||
                      (kind==='CH' && p.type==='Cup & Handle');
        if(match && p.confidence>bestConf){ bestConf=p.confidence; bestIndex=i; }
      });
      if(bestIndex>=0) focusPattern(bestIndex,true); else { setFullView(); state.focused=null; drawChart(); }
    });
    tile.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); tile.click(); }});
  });

  [els.tiSide, els.tiEntry, els.tiStop, els.tiT1, els.tiT2, els.tiT3, els.accSize, els.riskPct, els.feesPs].forEach(el=> el.addEventListener('input', updateRiskTable));
  els.btnValidateVol.addEventListener('click', validateVolume);
  els.btnScanNews.addEventListener('click', scanNews);

  state.raw=[]; setFullView(); drawChart();
  try{ new ResizeObserver(()=>drawChart()).observe(els.chart); } catch(e){ window.addEventListener('resize', drawChart); }
})();
</script>
</body>
</html>
§M
